<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Kubernetes" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="​ K8s是谷歌在2014年开源的容器化集群管理系统，使用k8s进行容器化应用部署。k8s利于应用的扩展，让容器化应用更加简洁高效。" /><meta property="og:description" content="​ K8s是谷歌在2014年开源的容器化集群管理系统，使用k8s进行容器化应用部署。k8s利于应用的扩展，让容器化应用更加简洁高效。" /><link rel="canonical" href="https://carmanzheng.github.io//posts/Kubernetes%E6%A6%82%E8%BF%B0/" /><meta property="og:url" content="https://carmanzheng.github.io//posts/Kubernetes%E6%A6%82%E8%BF%B0/" /><meta property="og:site_name" content="Technical Blogs" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-17T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Kubernetes" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"​ K8s是谷歌在2014年开源的容器化集群管理系统，使用k8s进行容器化应用部署。k8s利于应用的扩展，让容器化应用更加简洁高效。","headline":"Kubernetes","dateModified":"2022-07-08T16:41:16+08:00","datePublished":"2022-02-17T00:00:00+08:00","url":"https://carmanzheng.github.io//posts/Kubernetes%E6%A6%82%E8%BF%B0/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://carmanzheng.github.io//posts/Kubernetes%E6%A6%82%E8%BF%B0/"},"@context":"https://schema.org"}</script><title>Kubernetes | Technical Blogs</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Technical Blogs"><meta name="application-name" content="Technical Blogs"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/android-chrome-192x192.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Technical Blogs</a></div><div class="site-subtitle font-italic">Learning by Doing, Sharing for more!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Carmanzheng" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['zhengkan1993','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Kubernetes</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Kubernetes</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/carmanzheng">carmanzheng</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" date="2022-02-17 00:00:00 +0800" data-toggle="tooltip" data-placement="bottom" title="2022-02-17, 00:00 +0800" >02-17</em> </span> <span> 更新于 <em class="timeago" date="2022-07-08 16:41:16 +0800 " data-toggle="tooltip" data-placement="bottom" title="2022-07-08, 16:41 +0800" >07-08</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3183 字"> <em>17 分钟</em>阅读</span></div></div></div><div class="post-content"><p>​ K8s是谷歌在2014年开源的容器化集群管理系统，使用k8s进行容器化应用部署。k8s利于应用的扩展，让容器化应用更加简洁高效。</p><p>1.自动装箱</p><p>​ 基于容器对应用运行环境的资源配置要求，自动部署应用容器</p><p>2.自我修复</p><p>​ 当容器失败时，会对容器进行重启</p><p>​ 当所部署的Node节点有问题时，会对容器进行重新部署和重新调度</p><p>​ 当容器未通过监控检查时，会关闭此容器；直到容器正常运行时，才对外提供服务</p><p>3.水平扩展</p><p>​ 通过简单的命令、用户UI界面或基于CPU等资源的使用情况，对应用容器进行规模化扩大或规模剪裁</p><p>4.滚动更新</p><p>​ 可以根据应用的变化，对运行的应用进行一次性或者批量式更新</p><p>5.版本回退</p><p>​ 根据应用部署情况，进行历史版本的即时回退</p><p>6.秘钥和配置管理</p><p>​ 在不需要重新构建镜像的情况下，可以部署和更新秘钥和应用配置，类似热部署</p><p>7.存储编排</p><p>​ 自动实现存储系统挂载和应用，特别对有状态应用实现数据持久化非常重要。存储系统可以来自本地目录、网络存储（NFS、Gluster、Ceph等）、公共云存储服务</p><p>8.批处理</p><p>​ 提供一次性任务、定时任务；满足批量数据处理和分析的场景。</p><h3 id="1部署方式">1.部署方式<a href="#1部署方式" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="table-wrapper"><table><thead><tr><th style="text-align: center">部署方 式<th style="text-align: left">说明<tbody><tr><td style="text-align: center"><strong>传统部署方式</strong><td style="text-align: left">应用直接在物理机上部署，机器的资源分配不好，出现bug时，可能机器的大部分资源被某个应用占用，导致其他应用无法正常运行，无法做到应用隔离<tr><td style="text-align: center"><strong>虚拟机部署</strong><td style="text-align: left">在单个物理机上运行多个虚拟机， 每个虚拟机都是完整独立的系统，性能损耗大<tr><td style="text-align: center"><strong>容器部署</strong><td style="text-align: left">所有容器共享主机的系统，相当于轻量级的虚拟机，性能损耗小，资源隔离，CPU内存实现按需分配</table></div><h3 id="2应用场景">2.应用场景<a href="#2应用场景" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="table-wrapper"><table><thead><tr><th>集群规模<th>部署方式<tbody><tr><td><strong>单台机器</strong><td>直接使用docker + docker-compose就够了，方便轻松<tr><td><strong>多台机器（3-4台）</strong><td>单台机器单独配置运行环境+负载均衡器、，亦可以轻松化解<tr><td><strong>n多台机器（成百上千）</strong><td>借助k8s，可实现集中式的管理集群机器和应用，加机器、版本升级、版本回滚、不停机的灰度更新，确保高可用、高性能、高扩展</table></div><h3 id="3kubernetes集群架构说明">3.Kubernetes集群架构说明<a href="#3kubernetes集群架构说明" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-src="D:D:\07_GitHub\GitHub_Blogs\assets\images\20220217K8Sprofile\image-20220620205346099.png7_GitHub\GitHub_Blogs\assets\images0220217K8Sprofile\image-20220620205346099.png" alt="image-20220620205346099" style="zoom:67%;" data-proofer-ignore></p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">概念<th>说明<tbody><tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">master node</code><td>主节点：控制平台，不需要很高的性能、不跑任务，通常一个就行了，也可以开多个主节点来提高集群的可用度<tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">kube-apiserver</code><td>API 服务器，公开了 Kubernetes API；集群同一入口，以restful方式，交给etcd存储<tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">etcd</code><td>存储系统，保存 Kubernetes 所有集群数据的后台数据库<tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">kube-scheduler</code><td>节点调度，调度 Pod 到哪个节点运行<tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">kube-controller</code><td>集群控制器，处理集群中常规后台任务，一个资源对应一个控制器<tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">cloud-controller</code><td>与云服务商交互</table></div><div class="table-wrapper"><table><thead><tr><th style="text-align: center">概念<th>说明<tbody><tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">worker node</code><td>工作节点：可以是物理机或者虚拟机，任务都在这里跑，机器的性能需要好点；通常有很多个，可以不断的加机器扩大集群；每个工作节点都由主节点管理<tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">Pod</code><td>K8S管理和调度的最小单位；<code class="language-plaintext highlighter-rouge">每个pod都有自己的虚拟IP</code>。Pod内部容器共享同一IP；一个工作节点可以有多个pod，一个pod可以包含一个或多个容器；主节点会考量负载自动调度pod的运行位置；<tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">kublet</code><td>master排到node的节点代表，管理本机容器<tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">kube-proxy</code><td>提供网络代理，负载均衡等操作</table></div><h3 id="4kubernetes集群部署方式">4.Kubernetes集群部署方式<a href="#4kubernetes集群部署方式" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-src="D:D:\07_GitHub\GitHub_Blogs\assets\images\20220217K8Sprofile\04-第二部分7_GitHub\GitHub_Blogs\assets\images0220217K8SprofileD:\07_GitHub\GitHub_Blogs\assets\images\20220217K8Sprofile\04-第二部分4-第二部分 k8s集群搭建（平台规划和搭建方式介绍）.png" style="zoom: 50%;" data-proofer-ignore></p><p>https://github.com/lework/kainstall</p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">K8S部署方式<th style="text-align: center">说明<th style="text-align: center">特点<tbody><tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">minikube</code><td style="text-align: center">Minicube是一个工具，可以在本地快速运行一个单点的Kubernetes，仅用于尝试kubernetes或日常开发的用户使用 参考 ：<code class="language-plaintext highlighter-rouge">https://minikube.sigs.k8s.io/docs/tutorials/</code><td style="text-align: center"> <tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">kubeadm</code><td style="text-align: center">Kubeadm也是一个工具，提供<code class="language-plaintext highlighter-rouge">kubeadm init </code>和<code class="language-plaintext highlighter-rouge">kubeadm join</code>，用于快速部署<code class="language-plaintext highlighter-rouge">Kubernetes</code>集群，参考：<code class="language-plaintext highlighter-rouge">https://kubernetes.io/docs/tasks/tools/</code><td style="text-align: center">快速，但是产生错误不好排除<tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">二进制</code><td style="text-align: center">推荐，从官方下载发行版的二进制包，手动部署每个组件，组成k8s集群<td style="text-align: center">手动，配置过程较为复杂，但是出现问题能够良好的排除，且能了解K8S的详细流程</table></div><h3 id="5kubeadm搭建">5.Kubeadm搭建<a href="#5kubeadm搭建" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>​ kubeadm是官方社区推出的一个用于快速部署k8s集群的工具，这个工具能通过两条指令完成一个k8s集群的部署。</p><p>第一步，创建一个Master节点 <code class="language-plaintext highlighter-rouge">kubeadm init</code></p><p>第二步，将Node节点加入到已创建的Master节点中 <code class="language-plaintext highlighter-rouge">kubeadm join Master的ip和端口</code></p><h4 id="1系统初始化">1.系统初始化<a href="#1系统初始化" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>一台或者多台机器，操作系统centos7以上版本<li>硬件配置：RAM至少2GB，CPU至少2核，硬盘至少30GB<li>集群中所有机器之间网络互通<li>可以访问外网（需要拉取镜像）<li>进制swap分区</ul><p><code class="language-plaintext highlighter-rouge">每台机器执行</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c"># 关闭防火墙</span>
systemctl stop firewall
systemctl disable firewall

<span class="c"># 关闭selinux</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/enforcing/disable'</span> /etc/selinux/config <span class="c"># 永久关闭</span>
setenforce 0 <span class="c"># 临时关闭</span>

<span class="c"># 关闭swap</span>
<span class="nb">sed</span> <span class="nt">-ri</span> <span class="s1">'s/.*swap.*/%&amp;/'</span> /etc/fstab <span class="c">#永久关闭</span>
swapoff <span class="nt">-a</span> <span class="c"># 临时关闭</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">三台机器分别执行</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c"># 根据规划设置主机名</span>
hostnamectl set-hostname k8smaster
hostnamectl set-hostname k8snode1
hostnamectl set-hostname k8snode2

<span class="c"># 将桥接的IPV4流量传递到iptables的链路</span>
<span class="nb">cat</span> /etc/sysctl.d/k8s.conf <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
net.bridge.bridge-nf-call-ip6tables = 1 
net.bridge.bridge-nf-call-iptables = 1
</span><span class="no">EOF 

</span>system <span class="nt">--system</span>   <span class="c"># 生效</span>

<span class="c"># 时间同步</span>
yum <span class="nb">install </span>ntpdate <span class="nt">-y</span>
ntpdate time.windows.com
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">在master主机上添加</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nb">cat</span> <span class="o">&gt;&gt;</span> /etc/hosts <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
192.168.44.146 k8smaster
192.168.44.147 k8snode1
192.168.44.148 k8snode2
</span><span class="no">EOF
</span></pre></table></code></div></div><h4 id="2所有节点安装软件">2.所有节点安装软件<a href="#2所有节点安装软件" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>所有节点都需要安装Docker、kubeadm和kubelet</p><p><code class="language-plaintext highlighter-rouge">三台机器操作</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="c"># （1）安装 Docker</span>
<span class="nv">$ </span>wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo <span class="nt">-O</span>
/etc/yum.repos.d/docker-ce.repo
<span class="nv">$ </span>yum <span class="nt">-y</span> <span class="nb">install </span>docker-ce-18.06.1.ce-3.el7
<span class="nv">$ </span>systemctl <span class="nb">enable </span>docker <span class="o">&amp;&amp;</span> systemctl start docker
<span class="nv">$ </span>docker <span class="nt">--version</span>

<span class="c"># （2）添加阿里云 YUM 软件源</span>
<span class="c"># 设置仓库地址</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> /etc/docker/daemon.json <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
{
"registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]
}
</span><span class="no">EOF
</span><span class="c"># 重启docker</span>
<span class="nv">$ </span>systemctl restart docker

<span class="c"># 设置yum源</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> /etc/yum.repos.d/kubernetes.repo <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
[kubernetes]
name=Kubernete
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span><span class="no">EOF

</span><span class="c">#（3）安装 kubeadm，kubelet 和 kubect</span>
<span class="nv">$ </span>yum <span class="nb">install</span> <span class="nt">-y</span> kubelet kubeadm kubectl
<span class="nv">$ </span>systemctl <span class="nb">enable </span>kubelet
</pre></table></code></div></div><h4 id="3部署k8s-master-和-node">3.部署k8s Master 和 Node<a href="#3部署k8s-master-和-node" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>在192.168.44.146（master节点）上执行</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubeadm init <span class="se">\</span>
<span class="nt">--apiserver-advertise-address</span><span class="o">=</span>192.168.44.146 <span class="se">\ </span>  <span class="c"># 与master节点ip对应</span>
<span class="nt">--image-repository</span> registry.aliyuncs.com/google_containers <span class="se">\ </span> <span class="c"># 镜像仓库</span>
<span class="nt">--kubernetes-version</span> v1.17.0 <span class="se">\ </span>  <span class="c"># 填写当前k8s版本</span>
<span class="nt">--service-cidr</span><span class="o">=</span>10.96.0.0/12 <span class="se">\ </span>   <span class="c"># 填写与当前ip不同的IP段</span>
<span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16 <span class="c"># 填写与当前ip不同的IP段</span>
</pre></table></code></div></div><p>这个过程使用docker拉取官方镜像，由于默认拉取镜像地址 k8s.gcr.io 国内无法访问，这里指定阿里云镜像仓库地址（即aliyuncs.com/google_containers仓库）。</p><p>后面就会出现拉取成功的提示</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Your Kubernetes control-plane has initialized successfully!
....
提示语
....
You should ... 
Then ...<span class="o">(</span>这个后面的提示在node节点执行<span class="o">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">使用kubectl创建,在master节点(You should 后面出现的话)</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">在node节点(出现在提示中then后面的话)</code></p><p>向集群添加新节点，执行在 kubeadm init 输出的 kubeadm join命令</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubeadm <span class="nb">join </span>192.168.44.146:6443 <span class="nt">--token</span> esce21.q6hetwm8si29qxwn <span class="se">\</span>
<span class="nt">--discovery-token-ca-cert-hash</span>
sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5
</pre></table></code></div></div><p>加入完之后，在master中查看节点</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl get nodes
</pre></table></code></div></div><h4 id="4安装pod网络插件cni">4.安装Pod网络插件（CNI）<a href="#4安装pod网络插件cni" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p><code class="language-plaintext highlighter-rouge">在master节点</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl apply –f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
<span class="nv">$ </span>kubectl get pods <span class="nt">-n</span> kube-system
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</code>如下内容</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
</pre><td class="rouge-code"><pre><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">policy/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PodSecurityPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">psp.flannel.unprivileged</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">seccomp.security.alpha.kubernetes.io/allowedProfileNames</span><span class="pi">:</span> <span class="s">docker/default</span>
    <span class="na">seccomp.security.alpha.kubernetes.io/defaultProfileName</span><span class="pi">:</span> <span class="s">docker/default</span>
    <span class="na">apparmor.security.beta.kubernetes.io/allowedProfileNames</span><span class="pi">:</span> <span class="s">runtime/default</span>
    <span class="na">apparmor.security.beta.kubernetes.io/defaultProfileName</span><span class="pi">:</span> <span class="s">runtime/default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">privileged</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">volumes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">configMap</span>
  <span class="pi">-</span> <span class="s">secret</span>
  <span class="pi">-</span> <span class="s">emptyDir</span>
  <span class="pi">-</span> <span class="s">hostPath</span>
  <span class="na">allowedHostPaths</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">pathPrefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/etc/cni/net.d"</span>
  <span class="pi">-</span> <span class="na">pathPrefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/etc/kube-flannel"</span>
  <span class="pi">-</span> <span class="na">pathPrefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/run/flannel"</span>
  <span class="na">readOnlyRootFilesystem</span><span class="pi">:</span> <span class="no">false</span>
  <span class="c1"># Users and groups</span>
  <span class="na">runAsUser</span><span class="pi">:</span>
    <span class="na">rule</span><span class="pi">:</span> <span class="s">RunAsAny</span>
  <span class="na">supplementalGroups</span><span class="pi">:</span>
    <span class="na">rule</span><span class="pi">:</span> <span class="s">RunAsAny</span>
  <span class="na">fsGroup</span><span class="pi">:</span>
    <span class="na">rule</span><span class="pi">:</span> <span class="s">RunAsAny</span>
  <span class="c1"># Privilege Escalation</span>
  <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">defaultAllowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
  <span class="c1"># Capabilities</span>
  <span class="na">allowedCapabilities</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">NET_ADMIN'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">NET_RAW'</span><span class="pi">]</span>
  <span class="na">defaultAddCapabilities</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">requiredDropCapabilities</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="c1"># Host namespaces</span>
  <span class="na">hostPID</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hostIPC</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hostNetwork</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">hostPorts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">min</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">max</span><span class="pi">:</span> <span class="m">65535</span>
  <span class="c1"># SELinux</span>
  <span class="na">seLinux</span><span class="pi">:</span>
    <span class="c1"># SELinux is unused in CaaSP</span>
    <span class="na">rule</span><span class="pi">:</span> <span class="s1">'</span><span class="s">RunAsAny'</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">flannel</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">extensions'</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">podsecuritypolicies'</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">use'</span><span class="pi">]</span>
  <span class="na">resourceNames</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">psp.flannel.unprivileged'</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nodes/status</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">patch</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">flannel</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">flannel</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">flannel</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">flannel</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-flannel-cfg</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">tier</span><span class="pi">:</span> <span class="s">node</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">flannel</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">cni-conf.json</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">{</span>
      <span class="s">"name": "cbr0",</span>
      <span class="s">"cniVersion": "0.3.1",</span>
      <span class="s">"plugins": [</span>
        <span class="s">{</span>
          <span class="s">"type": "flannel",</span>
          <span class="s">"delegate": {</span>
            <span class="s">"hairpinMode": true,</span>
            <span class="s">"isDefaultGateway": true</span>
          <span class="s">}</span>
        <span class="s">},</span>
        <span class="s">{</span>
          <span class="s">"type": "portmap",</span>
          <span class="s">"capabilities": {</span>
            <span class="s">"portMappings": true</span>
          <span class="s">}</span>
        <span class="s">}</span>
      <span class="s">]</span>
    <span class="s">}</span>
  <span class="na">net-conf.json</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">{</span>
      <span class="s">"Network": "10.244.0.0/16",</span>
      <span class="s">"Backend": {</span>
        <span class="s">"Type": "vxlan"</span>
      <span class="s">}</span>
    <span class="s">}</span>
<span class="s">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DaemonSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-flannel-ds</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">tier</span><span class="pi">:</span> <span class="s">node</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">flannel</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">flannel</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">tier</span><span class="pi">:</span> <span class="s">node</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">flannel</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">affinity</span><span class="pi">:</span>
        <span class="na">nodeAffinity</span><span class="pi">:</span>
          <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
            <span class="na">nodeSelectorTerms</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">matchExpressions</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">kubernetes.io/os</span>
                <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
                <span class="na">values</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s">linux</span>
      <span class="na">hostNetwork</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">priorityClassName</span><span class="pi">:</span> <span class="s">system-node-critical</span>
      <span class="na">tolerations</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
        <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">flannel</span>
      <span class="na">initContainers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">install-cni-plugin</span>
       <span class="c1">#image: flannelcni/flannel-cni-plugin:v1.1.0 for ppc64le and mips64le (dockerhub limitations may apply)</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">cp</span>
        <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">-f</span>
        <span class="pi">-</span> <span class="s">/flannel</span>
        <span class="pi">-</span> <span class="s">/opt/cni/bin/flannel</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cni-plugin</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/opt/cni/bin</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">install-cni</span>
       <span class="c1">#image: flannelcni/flannel:v0.18.1 for ppc64le and mips64le (dockerhub limitations may apply)</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rancher/mirrored-flannelcni-flannel:v0.18.1</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">cp</span>
        <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">-f</span>
        <span class="pi">-</span> <span class="s">/etc/kube-flannel/cni-conf.json</span>
        <span class="pi">-</span> <span class="s">/etc/cni/net.d/10-flannel.conflist</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cni</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/cni/net.d</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">flannel-cfg</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/kube-flannel/</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">kube-flannel</span>
       <span class="c1">#image: flannelcni/flannel:v0.18.1 for ppc64le and mips64le (dockerhub limitations may apply)</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">rancher/mirrored-flannelcni-flannel:v0.18.1</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/opt/bin/flanneld</span>
        <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">--ip-masq</span>
        <span class="pi">-</span> <span class="s">--kube-subnet-mgr</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">100m"</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">50Mi"</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">100m"</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">50Mi"</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">privileged</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">capabilities</span><span class="pi">:</span>
            <span class="na">add</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">NET_ADMIN"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">NET_RAW"</span><span class="pi">]</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAME</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.name</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POD_NAMESPACE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.namespace</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">EVENT_QUEUE_DEPTH</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">5000"</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">run</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/run/flannel</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">flannel-cfg</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/kube-flannel/</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">xtables-lock</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/run/xtables.lock</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">run</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/run/flannel</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cni-plugin</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/opt/cni/bin</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cni</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/cni/net.d</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">flannel-cfg</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">kube-flannel-cfg</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">xtables-lock</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/run/xtables.lock</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">FileOrCreate</span>
</pre></table></code></div></div><h4 id="5测试-kubernetes-集群">5.测试 kubernetes 集群<a href="#5测试-kubernetes-集群" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>在 Kubernetes 集群中创建一个 pod，验证是否正常运行：</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>kubectl create deployment nginx <span class="nt">--image</span><span class="o">=</span>nginx
<span class="nv">$ </span>kubectl expose deployment nginx <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--type</span><span class="o">=</span>NodePort <span class="c"># NodPort需要定义,此时为本pod的ip</span>
<span class="nv">$ </span>kubectl get pod
</pre></table></code></div></div><p>访问地址：http://NodeIP:Port，在master节点上此时就是 <code class="language-plaintext highlighter-rouge">192.168.44.146:32753</code>,其中端口需要看上面命令(get pod)给出来的暴露端口</p><h3 id="6二进制源码搭建">6.二进制源码搭建<a href="#6二进制源码搭建" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><h4 id="1系统初始化-1">1.系统初始化<a href="#1系统初始化-1" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p><img data-src="D:D:\07_GitHub\GitHub_Blogs\assets\images\20220217K8Sprofile\06-第二部分7_GitHub\GitHub_Blogs\assets\images0220217K8SprofileD:\07_GitHub\GitHub_Blogs\assets\images\20220217K8Sprofile\06-第二部分6-第二部分 搭建k8s集群（二进制方式）.png" style="zoom: 67%;" data-proofer-ignore></p><ul><li>一台或者多台机器，操作系统centos7以上版本<li>硬件配置：RAM至少2GB，CPU至少2核，硬盘至少30GB<li>集群中所有机器之间网络互通<li>可以访问外网（需要拉取镜像）<li>进制swap分区</ul><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c"># 关闭防火墙</span>
systemctl stop firewalld
systemctl disable firewalld
<span class="c"># 关闭selinux, 所有节点关闭 SELinux</span>
setenforce 0
<span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">--follow-symlinks</span> <span class="s1">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/sysconfig/selinux
<span class="c"># 关闭swap</span>
<span class="c"># 同步服务器时间 (ntpdate time.windows.com),不联网可以自己设定时间，总之保持时间一致</span>
<span class="c"># 更改HOST文件(基于主机名通信，所以要进行IP和主机名的绑定，这个在Master机器上更改就行)</span>
vim /etc/hosts
172.16.32.2 node1
172.16.32.6 node2
172.16.0.4 master
<span class="c"># 每个节点分别设置对应主机名</span>
homenamectl set-homename k8s-master
homenamectl set-homename k8s-node1
homenamectl set-homename k8s-node2
</pre></table></code></div></div><h4 id="2签发证书">2.签发证书<a href="#2签发证书" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c"># 准备cfssl工具</span>
<span class="c"># 自签etcd ssl证书</span>
wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
<span class="nb">chmod</span> +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
<span class="nb">mv </span>cfssl_linux-amd64 /usr/local/bin/cfssl
<span class="nb">mv </span>cfssljson_linux-amd64 /usr/local/bin/cfssljson
<span class="nb">mv </span>cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</pre></table></code></div></div><h4 id="3下发证书">3.下发证书<a href="#3下发证书" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4><p>二进制包下载地址：<code class="language-plaintext highlighter-rouge">https://github.com/etcd-io/etcd/releases</code></p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="c"># 部署etcd</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E8%BE%B9%E7%BC%98%E8%AE%A1%E7%AE%97/'>边缘计算</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/devops/" class="post-tag no-text-decoration" >DevOps</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Kubernetes - Technical Blogs&url=https://carmanzheng.github.io//posts/Kubernetes%E6%A6%82%E8%BF%B0/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Kubernetes - Technical Blogs&u=https://carmanzheng.github.io//posts/Kubernetes%E6%A6%82%E8%BF%B0/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Kubernetes - Technical Blogs&url=https://carmanzheng.github.io//posts/Kubernetes%E6%A6%82%E8%BF%B0/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Kubernetes%E6%A6%82%E8%BF%B0/">Kubernetes</a><li><a href="/posts/%E6%95%B0%E6%8D%AE%E5%BA%93-MySQL%E7%B4%A2%E5%BC%95%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">MySQL存储引擎</a><li><a href="/posts/Linux%E5%9F%BA%E7%A1%80/">Linux基础</a><li><a href="/posts/Python-%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%9A%E7%BA%BF%E7%A8%8B/">Python基操-多进程与多线程</a><li><a href="/posts/%E5%89%8D%E7%AB%AF-Vue%E8%B7%AF%E7%94%B1%E4%B8%8EVuex/">前端 Vue路由与vuex</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/python%E5%9F%BA%E6%93%8D/">Python基操</a> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AFjs/">前端JS</a> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AFvue/">前端Vue</a> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AFcss/">前端CSS</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/linux%E5%9F%BA%E7%A1%80/">Linux基础</a> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AFhtml/">前端HTML</a> <a class="post-tag" href="/tags/github/">Github</a> <a class="post-tag" href="/tags/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91/">客户端开发</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Nginx/"><div class="card-body"> <em class="timeago small" date="2022-01-24 00:00:00 +0800" >01-24</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Nginx</h3><div class="text-muted small"><p> 本文主要介绍Nginx内容，Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP/POP3/SMTP服务。Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。 它不仅是一个高性能的HTTP和反向代理服务器，同时也是一个IMAP/POP3/...</p></div></div></a></div><div class="card"> <a href="/posts/docker%E5%9F%BA%E7%A1%80/"><div class="card-body"> <em class="timeago small" date="2022-02-15 00:00:00 +0800" >02-15</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker基础</h3><div class="text-muted small"><p> 本文主要对docker的基础知识进行介绍，了解docker的镜像、容器和仓库。 1.镜像 docker的镜像实由一层一层的文件系统组成，这种层级的文件系统采用联合文件系统编写（UnionFS)，优点：共享资源。 即有多个镜像从相同的base镜像构建而来，那么宿主机上只需要在磁盘上保存一份base镜像，同时内存中只需要加载一份base镜像，就可以为所有容器提供服务了，且镜像的每一层都能被...</p></div></div></a></div><div class="card"> <a href="/posts/Docker-Compose-%E7%A9%BA/"><div class="card-body"> <em class="timeago small" date="2022-02-16 00:00:00 +0800" >02-16</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker-Compose</h3><div class="text-muted small"><p> 1. Docker Compose简介 ​ Docker Compose是一个用来定义和运行复杂应用的Docker工具。一个使用Docker容器的应用，通常由多个容器组成。使用Docker Compose不再需要使用shell脚本来启动容器。 ​ Docker Compose 通过一个配置文件（yml文件）来管理多个Docker容器，在配置文件中，所有的容器通过services来定义...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Docker-Compose-%E7%A9%BA/" class="btn btn-outline-primary" prompt="上一篇"><p>Docker-Compose</p></a> <span class="btn btn-outline-primary disabled" prompt="下一篇"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/carmanzheng">carmanzheng</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/python%E5%9F%BA%E6%93%8D/">Python基操</a> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AFjs/">前端JS</a> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AFvue/">前端Vue</a> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AFcss/">前端CSS</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/linux%E5%9F%BA%E7%A1%80/">Linux基础</a> <a class="post-tag" href="/tags/%E5%89%8D%E7%AB%AFhtml/">前端HTML</a> <a class="post-tag" href="/tags/github/">Github</a> <a class="post-tag" href="/tags/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91/">客户端开发</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
